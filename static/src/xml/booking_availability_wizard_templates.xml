<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="tl_rental_manager.BookingAvailabilityWizard">
        <Dialog title="'Check Availability'" size="'xl'">
            <div class="o_tlrm_booking_wizard">
                <!-- Loading State -->
                <t t-if="state.loading">
                    <div class="d-flex justify-content-center align-items-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </t>

                <!-- Error State -->
                <t t-elif="state.error">
                    <div class="alert alert-danger m-3">
                        <strong>Error:</strong> <t t-esc="state.error"/>
                    </div>
                </t>

                <!-- Grid Content -->
                <t t-else="">
                    <!-- Control Panel -->
                    <div class="d-flex align-items-center justify-content-between p-2 border-bottom bg-light">
                        <div class="d-flex align-items-center gap-2">
                            <!-- View Mode Toggle -->
                            <div class="btn-group btn-group-sm">
                                <button type="button" 
                                        t-att-class="'btn ' + (state.viewMode === 'week' ? 'btn-primary' : 'btn-outline-secondary')"
                                        t-on-click="() => state.viewMode !== 'week' &amp;&amp; this.toggleViewMode()">
                                    Weeks
                                </button>
                                <button type="button" 
                                        t-att-class="'btn ' + (state.viewMode === 'day' ? 'btn-primary' : 'btn-outline-secondary')"
                                        t-on-click="() => state.viewMode !== 'day' &amp;&amp; this.toggleViewMode()">
                                    Days
                                </button>
                            </div>

                            <!-- Navigation -->
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" t-on-click="previousPeriod">
                                    <i class="fa fa-chevron-left"/>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" t-on-click="goToToday">
                                    Today
                                </button>
                                <button type="button" class="btn btn-outline-secondary" t-on-click="nextPeriod">
                                    <i class="fa fa-chevron-right"/>
                                </button>
                            </div>
                        </div>

                        <div class="text-muted small">
                            Click and drag to select a date range
                        </div>

                        <div>
                            <t t-if="state.selectionStart">
                                <button type="button" class="btn btn-sm btn-outline-secondary" t-on-click="clearSelection">
                                    Clear Selection
                                </button>
                            </t>
                        </div>
                    </div>

                    <!-- No Products -->
                    <t t-if="rows.length === 0">
                        <div class="alert alert-info m-3">
                            No products in booking lines. Add products first.
                        </div>
                    </t>

                    <!-- Availability Grid -->
                    <t t-else="">
                        <div class="o_tlrm_wizard_grid_container" style="max-height: 400px; overflow: auto;"
                             t-on-mouseup="onCellMouseUp" t-on-mouseleave="onCellMouseUp">
                            <table class="table table-sm table-bordered mb-0 o_tlrm_wizard_table" style="table-layout: fixed;">
                                <thead class="bg-light" style="position: sticky; top: 0; z-index: 2;">
                                    <tr>
                                        <th style="width: 200px; position: sticky; left: 0; z-index: 3; background: #f8f9fa;">
                                            Product
                                        </th>
                                        <th style="width: 40px; text-align: center; background: #f8f9fa;">
                                            Qty
                                        </th>
                                        <t t-foreach="columns" t-as="col" t-key="col.key">
                                            <th class="text-center" 
                                                style="min-width: 60px; cursor: pointer; user-select: none;"
                                                t-att-class="isColumnSelected(col_index) ? 'bg-primary text-white' : ''"
                                                t-on-click="() => this.onColumnClick(col_index)">
                                                <small><t t-esc="col.label"/></small>
                                            </th>
                                        </t>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="rows" t-as="row" t-key="row.product_id">
                                        <tr>
                                            <td class="align-middle" style="position: sticky; left: 0; z-index: 1; background: white;">
                                                <t t-esc="row.display_name"/>
                                            </td>
                                            <td class="text-center align-middle" style="background: #f8f9fa;">
                                                <strong><t t-esc="neededByProduct[row.product_id] || 0"/></strong>
                                            </td>
                                            <t t-foreach="row.cells" t-as="cell" t-key="cell.column_key">
                                                <t t-set="isSelected" t-value="isCellSelected(row_index, cell_index)"/>
                                                <t t-set="cellColor" t-value="getCellColor(cell, row.base_capacity, isSelected)"/>
                                                <td class="text-center align-middle o_tlrm_wizard_cell"
                                                    t-att-style="'background-color: ' + cellColor + '; cursor: pointer; user-select: none;' + (isSelected ? ' outline: 2px solid #007bff; outline-offset: -2px;' : '')"
                                                    t-att-title="(cell.tooltip || '') + ' (Need: ' + (neededByProduct[row.product_id] || 0) + ')'"
                                                    t-on-mousedown="() => this.onCellMouseDown(row_index, cell_index)"
                                                    t-on-mouseenter="() => this.onCellMouseEnter(row_index, cell_index)">
                                                    <small><t t-esc="cell.available"/></small>
                                                </td>
                                            </t>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>

                        <!-- Selection Summary -->
                        <t t-if="selectionSummary">
                            <div class="border-top p-3 bg-light">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-2">Selected Period</h6>
                                        <p class="mb-1">
                                            <strong>From:</strong> <t t-esc="selectionSummary.startLabel"/>
                                            <strong class="ms-3">To:</strong> <t t-esc="selectionSummary.endLabel"/>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-2">Availability Check</h6>
                                        <t t-if="selectionSummary.allFit">
                                            <div class="alert alert-success py-2 mb-0">
                                                <i class="fa fa-check-circle me-2"/>
                                                All <t t-esc="selectionSummary.totalCount"/> products available!
                                            </div>
                                        </t>
                                        <t t-else="">
                                            <div class="alert alert-danger py-2 mb-0">
                                                <i class="fa fa-exclamation-circle me-2"/>
                                                <t t-esc="selectionSummary.fitCount"/> of <t t-esc="selectionSummary.totalCount"/> products available
                                            </div>
                                        </t>
                                    </div>
                                </div>

                                <!-- Product Status List -->
                                <t t-if="!selectionSummary.allFit">
                                    <div class="mt-3">
                                        <h6>Product Status:</h6>
                                        <ul class="list-unstyled mb-0">
                                            <t t-foreach="selectionSummary.productStatus" t-as="ps" t-key="ps.product_id">
                                                <li t-att-class="ps.fits ? 'text-success' : 'text-danger'">
                                                    <i t-att-class="ps.fits ? 'fa fa-check me-2' : 'fa fa-times me-2'"/>
                                                    <t t-esc="ps.display_name"/>
                                                    <span class="text-muted ms-2">(need <t t-esc="ps.needed"/>)</span>
                                                </li>
                                            </t>
                                        </ul>
                                    </div>
                                </t>
                            </div>
                        </t>
                    </t>
                </t>

                <!-- Footer Buttons -->
                <div class="d-flex justify-content-end gap-2 p-3 border-top">
                    <button type="button" class="btn btn-secondary" t-on-click="onCancel">
                        Cancel
                    </button>
                    <button type="button" 
                            t-att-class="'btn ' + (canConfirm ? 'btn-primary' : 'btn-secondary')"
                            t-att-disabled="!canConfirm"
                            t-on-click="onConfirm">
                        <i class="fa fa-check me-1"/>
                        Apply Dates
                    </button>
                </div>
            </div>
        </Dialog>
    </t>

</templates>
